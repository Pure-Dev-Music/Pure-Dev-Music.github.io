<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8" />
    <title>KK Wedding ‚Äì ‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡∏°</title>
    <style>
      :root {
        --bg: #f4f5fb;
        --surface: #ffffff;
        --line: #e2e8f0;
        --primary: #6366f1;
        --primary-soft: rgba(99,102,241,0.09);
        --accent: #f97316;
        --text: #0f172a;
        --muted: #64748b;
        --radius-lg: 20px;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #fef3f2, #eff6ff 55%, #f4f5fb);
        min-height: 100vh;
      }
      header {
        backdrop-filter: blur(10px);
        background: rgba(255,255,255,0.9);
        border-bottom: 1px solid rgba(148,163,184,0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 26px 12px;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .brand {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .brand-circle {
        width: 30px;
        height: 30px;
        border-radius: 9999px;
        background: linear-gradient(135deg, #6366f1, #ec4899);
        display: grid;
        place-items: center;
        color: #fff;
        font-size: 13px;
        font-weight: 700;
      }
      .brand-title {
        font-weight: 700;
        color: var(--text);
      }
      .tabs {
        background: #e2e8f0;
        border-radius: 9999px;
        padding: 4px;
        display: flex;
        gap: 4px;
      }
      .tab {
        border: none;
        background: transparent;
        padding: 6px 16px;
        border-radius: 9999px;
        font-size: 13px;
        color: #475569;
        cursor: pointer;
      }
      .tab.active {
        background: #fff;
        color: #0f172a;
        font-weight: 600;
        box-shadow: 0 1px 5px rgba(15,23,42,0.13);
      }
      .user-badge {
        background: #eef2ff;
        border: 1px solid rgba(99,102,241,0.15);
        padding: 4px 10px 4px 16px;
        border-radius: 9999px;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .role-pill {
        background: #6366f1;
        color: #fff;
        border-radius: 9999px;
        font-size: 11px;
        padding: 2px 8px;
        text-transform: uppercase;
      }

      main {
        max-width: 1200px;
        margin: 16px auto;
        padding: 0 18px 32px;
      }

      .filters {
        display: flex;
        gap: 10px;
        margin-bottom: 14px;
      }
      .input, .select {
        background: #fff;
        border: 1px solid rgba(99,102,241,0.09);
        border-radius: 9999px;
        padding: 6px 12px 6px 14px;
        font-size: 13px;
        color: #0f172a;
        outline: none;
      }
      .select {
        appearance: none;
        background-image: linear-gradient(45deg, transparent 50%, #94a3b8 50%), linear-gradient(135deg, #94a3b8 50%, transparent 50%);
        background-position: calc(100% - 12px) calc(50% - 3px), calc(100% - 7px) calc(50% - 3px);
        background-size: 5px 5px, 5px 5px;
        background-repeat: no-repeat;
        padding-right: 24px;
      }

      .card-table {
        background: #fff;
        border-radius: 18px;
        border: 1px solid rgba(148,163,184,0.25);
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(15,23,42,0.03);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead {
        background: #f8fafc;
      }
      th, td {
        padding: 10px 16px;
        font-size: 13px;
        border-bottom: 1px solid #eef2f7;
        text-align: left;
      }
      th {
        color: #475569;
        font-weight: 600;
        letter-spacing: .01em;
      }
      tr:hover td {
        background: rgba(99,102,241,0.03);
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: #eef2ff;
        color: #4338ca;
        padding: 1px 10px 2px;
        border-radius: 9999px;
        font-size: 12px;
        margin-right: 4px;
      }
      .money-admin {
        font-weight: 600;
        color: #15803d;
      }
      .money-cell.hidden {
        display: none;
      }

      @media (max-width: 900px) {
        .filters { flex-wrap: wrap; }
        th:nth-child(5), td:nth-child(5),
        th:nth-child(6), td:nth-child(6),
        th:nth-child(7), td:nth-child(7) {
          display: none;
        }
      }

        .row-past td {
          background: #e2f6e9 !important;  /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô */
        }
        .row-past:hover td {
          background: #d3f0de !important;
        }


    </style>
  </head>
  <body>
    <header>
      <div class="brand">
        <div class="brand-circle">KK</div>
        <div class="brand-title">KK Wedding ‚Äì ‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡∏°</div>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="all">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô</button>
        <button class="tab" data-tab="mine">‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
        <button class="tab" data-tab="report">‡∏™‡∏£‡∏∏‡∏õ / ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</button>
      </div>
      <div class="user-badge" id="userBox">
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
      </div>
    </header>

    <main>
      <div class="filters">
        <input type="date" id="dateFilter" class="input" />
        <input type="text" id="searchFilter" class="input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡πà‡∏ö‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏ß / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..." />
        <select id="memberFilter" class="select">
          <option value="">-- ‡∏ó‡∏µ‡∏°‡∏£‡∏±‡∏ô‡∏Ñ‡∏¥‡∏ß --</option>
        </select>
      </div>

      <div class="card-table">
        <table>
          <thead>
            <tr>
              <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th>‡∏Ñ‡∏π‡πà‡∏ö‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏ß</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
              <th>‡∏ô‡∏≤‡∏¢‡∏û‡∏¥‡∏ò‡∏µ</th>
              <th>‡∏ó‡∏µ‡∏°‡∏£‡∏±‡∏ô‡∏Ñ‡∏¥‡∏ß</th>
              <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
              <th id="thMoney">‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡∏°</th>
            </tr>
          </thead>
          <tbody id="jobsBody">
            <tr><td colspan="8">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
          </tbody>
        </table>
      </div>
    </main>

      <script>
      // state ‡∏´‡∏•‡∏±‡∏Å
      const STATE = {
        user: { email: "", name: "", role: "STAFF" },
        jobs: [],
        activeTab: "all"
      };

      // 1) ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô
      google.script.run
        .withSuccessHandler(function(user) {
          STATE.user = user;
          renderUserBadge();
          // ‡∏û‡∏≠‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡πà‡∏≠‡∏¢‡∏î‡∏∂‡∏á‡∏á‡∏≤‡∏ô
          loadJobs();
        })
        .getCurrentUser();

      function renderUserBadge() {
        const box = document.getElementById("userBox");
        box.innerHTML = `
          ${STATE.user.name || "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ"}
          <span class="role-pill">${STATE.user.role}</span>
        `;
      }

      // 2) ‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï‡∏´‡∏•‡∏±‡∏Å
      function loadJobs() {
        google.script.run
          .withSuccessHandler(function(jobs) {
            // jobs ‡πÄ‡∏õ‡πá‡∏ô array ‡∏Ç‡∏≠‡∏á object
            STATE.jobs = jobs.map(j => ({
              ...j,
              teamArray: j.team
                ? j.team.split(",").map(s => s.trim()).filter(Boolean)
                : []
            }));
            // üëá ‡∏™‡πà‡∏á user ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
            buildMemberFilter(STATE.jobs, STATE.user);
            renderJobs();
          })
          .getWeddingJobs();
      }

      // ============================
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á dropdown ‡∏ó‡∏µ‡∏°‡∏£‡∏±‡∏ô‡∏Ñ‡∏¥‡∏ß
      // ============================
      function buildMemberFilter(jobs, user) {
        const select = document.getElementById("memberFilter");
        // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô
        select.innerHTML = "";
        const optAll = document.createElement("option");
        optAll.value = "";
        optAll.textContent = "-- ‡∏ó‡∏µ‡∏°‡∏£‡∏±‡∏ô‡∏Ñ‡∏¥‡∏ß --";
        select.appendChild(optAll);

        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ADMIN ‚Üí ‡πÉ‡∏™‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
        if (user.role === "ADMIN") {
          const set = new Set();
          jobs.forEach(j => j.teamArray.forEach(n => set.add(n)));
          set.forEach(name => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
          });
          // admin ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ
          select.disabled = false;
          return;
        }

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ADMIN ‚Üí ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏Ñ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
        const optMe = document.createElement("option");
        optMe.value = user.name;
        optMe.textContent = user.name;
        select.appendChild(optMe);

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏•‡∏¢
        select.value = user.name;
        // ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πá‡∏•‡πá‡∏≠‡∏Å dropdown ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
        select.disabled = true;
      }
function getTodayIsoThai() {
    const now = new Date();
    // ‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏Å‡πà‡∏≠‡∏ô
    const thaiNow = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Bangkok" }));
    const y = thaiNow.getFullYear();
    const m = String(thaiNow.getMonth() + 1).padStart(2, "0");
    const d = String(thaiNow.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;   // ‡πÄ‡∏ä‡πà‡∏ô 2025-11-03
  }
      // 3) render ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
function renderJobs() {
  const body = document.getElementById("jobsBody");
  body.innerHTML = "";

  const selectedDate = document.getElementById("dateFilter").value;
  const keyword = document.getElementById("searchFilter").value.toLowerCase();
  const member = document.getElementById("memberFilter").value;
  const isAdmin = STATE.user.role === "ADMIN";

  let jobs = [...STATE.jobs];

  if (STATE.activeTab === "mine" && !isAdmin) {
    jobs = jobs.filter(j => j.teamArray.some(n => !!STATE.user.name && n === STATE.user.name));
  }

  jobs = jobs.filter(j => {
    let ok = true;
    if (selectedDate) ok = ok && j.date === selectedDate;
    if (keyword) {
      ok = ok && (
        (j.couple && j.couple.toLowerCase().includes(keyword)) ||
        (j.place && j.place.toLowerCase().includes(keyword))
      );
    }
    if (member) ok = ok && j.teamArray.includes(member);
    return ok;
  });

  // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
  if (!isAdmin) {
    document.getElementById("thMoney").style.display = "none";
  } else {
    document.getElementById("thMoney").style.display = "";
  }

  if (jobs.length === 0) {
    body.innerHTML = `<tr><td colspan="8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    return;
  }

  // üëá ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÑ‡∏ó‡∏¢) ‡∏°‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
  const todayIso = getTodayIsoThai();

  jobs.forEach(j => {
    const tr = document.createElement("tr");
    const timeText = (j.timeStart || j.timeEnd) ? `${j.timeStart || ""} - ${j.timeEnd || ""}` : "-";

    // üëá ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏á‡∏≤‡∏ô < ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
    const isPast = j.date && j.date < todayIso;
    if (isPast) {
      tr.classList.add("row-past");
    }

    const moneyHtml = (STATE.user.role === "ADMIN")
      ? `<span class="money-admin">‡πÉ‡∏™‡πà‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á</span>`
      : "";

    tr.innerHTML = `
      <td>${toThaiDate(j.date)}</td>
      <td>${timeText}</td>
      <td>${j.couple || "-"}</td>
      <td>${j.place || "-"}</td>
      <td>${j.mc || "-"}</td>
      <td>${j.teamArray.map(n => `<span class="badge">${n}</span>`).join(" ")}</td>
      <td>${j.customer || "-"}</td>
      <td class="money-cell ${STATE.user.role !== "ADMIN" ? "hidden" : ""}">${moneyHtml}</td>
    `;
    body.appendChild(tr);
  });
}


      function toThaiDate(iso) {
        if (!iso) return "-";
        const d = new Date(iso);
        return d.toLocaleDateString("th-TH", {
          day: "numeric",
          month: "short",
          year: "numeric"
        });
      }

      // 4) events
      document.querySelectorAll(".tab").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          STATE.activeTab = btn.dataset.tab;
          renderJobs();
        });
      });

      document.getElementById("dateFilter").addEventListener("change", renderJobs);
      document.getElementById("searchFilter").addEventListener("input", renderJobs);
      document.getElementById("memberFilter").addEventListener("change", renderJobs);
    </script>

  </body>
</html>

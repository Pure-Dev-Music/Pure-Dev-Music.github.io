<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <title>KK Wedding – จัดตารางทีม</title>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
      :root {
        --bg: #f4f5fb;
        --surface: #ffffff;
        --line: #e2e8f0;
        --primary: #6366f1;
        --primary-soft: rgba(99,102,241,0.09);
        --accent: #f97316;
        --text: #0f172a;
        --muted: #64748b;
        --radius-lg: 20px;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #fef3f2, #eff6ff 55%, #f4f5fb);
        min-height: 100vh;
      }
      header {
        backdrop-filter: blur(10px);
        background: rgba(255,255,255,0.9);
        border-bottom: 1px solid rgba(148,163,184,0.2);
        display: flex; justify-content: space-between; align-items: center;
        padding: 14px 26px 12px; position: sticky; top: 0; z-index: 100;
      }
      .brand { display: flex; gap: 10px; align-items: center; }
      .brand-circle { width: 30px; height: 30px; border-radius: 9999px;
        background: linear-gradient(135deg, #6366f1, #ec4899);
        display: grid; place-items: center; color: #fff; font-size: 13px; font-weight: 700; }
      .brand-title { font-weight: 700; color: var(--text); }

      .tabs { background: #e2e8f0; border-radius: 9999px; padding: 4px; display: flex; gap: 4px; }
      .tab { border: none; background: transparent; padding: 6px 16px; border-radius: 9999px; font-size: 13px; color: #475569; cursor: pointer; }
      .tab.active { background: #fff; color: #0f172a; font-weight: 600; box-shadow: 0 1px 5px rgba(15,23,42,0.13); }

      .user-badge { background: #eef2ff; border: 1px solid rgba(99,102,241,0.15);
        padding: 4px 10px 4px 16px; border-radius: 9999px; font-size: 13px; display: flex; align-items: center; gap: 8px; }
      .role-pill { background: #6366f1; color: #fff; border-radius: 9999px; font-size: 11px; padding: 2px 8px; text-transform: uppercase; }

      main { max-width: 1200px; margin: 16px auto; padding: 0 18px 32px; }

      .filters { display: flex; gap: 10px; margin-bottom: 14px; }
      .input, .select { background: #fff; border: 1px solid rgba(99,102,241,0.09); border-radius: 9999px; padding: 6px 12px 6px 14px; font-size: 13px; color: #0f172a; outline: none; }
      .select {
        appearance: none;
        background-image: linear-gradient(45deg, transparent 50%, #94a3b8 50%), linear-gradient(135deg, #94a3b8 50%, transparent 50%);
        background-position: calc(100% - 12px) calc(50% - 3px), calc(100% - 7px) calc(50% - 3px);
        background-size: 5px 5px, 5px 5px; background-repeat: no-repeat; padding-right: 24px;
      }

      .card-table { background: #fff; border-radius: 18px; border: 1px solid rgba(148,163,184,0.25); overflow: hidden; box-shadow: 0 10px 30px rgba(15,23,42,0.03); }
      table { width: 100%; border-collapse: collapse; }
      thead { background: #f8fafc; }
      th, td { padding: 10px 16px; font-size: 13px; border-bottom: 1px solid #eef2f7; text-align: left; }
      th { color: #475569; font-weight: 600; letter-spacing: .01em; }
      tr:hover td { background: rgba(99,102,241,0.03); }
      .badge { display: inline-flex; align-items: center; gap: 4px; background: #eef2ff; color: #4338ca; padding: 1px 10px 2px; border-radius: 9999px; font-size: 12px; margin-right: 4px; }
      .money-admin { font-weight: 600; color: #15803d; }
      .money-cell.hidden { display: none; }

      .login-wrap { max-width: 420px; margin: 64px auto; padding: 28px; border: 1px solid rgba(148,163,184,0.25);
        border-radius: 16px; background: #fff; text-align: center; box-shadow: 0 8px 24px rgba(15,23,42,.06); }
      .login-title { margin: 0 0 10px; font-size: 20px; }
      .login-desc { color: #475569; margin-bottom: 18px; font-size: 13px; }

      @media (max-width: 900px) {
        .filters { flex-wrap: wrap; }
        th:nth-child(5), td:nth-child(5),
        th:nth-child(6), td:nth-child(6),
        th:nth-child(7), td:nth-child(7) { display: none; }
      }
    </style>
  </head>

  <body>
    <header>
      <div class="brand">
        <div class="brand-circle">KK</div>
        <div class="brand-title">KK Wedding – จัดตารางทีม</div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="all">ตารางงาน</button>
        <button class="tab" data-tab="mine">งานของฉัน</button>
        <button class="tab" data-tab="report">สรุป / จ่ายเงิน</button>
      </div>

      <div class="user-badge" id="userBox">ยังไม่ได้ล็อกอิน</div>
    </header>

    <!-- ========= LOGIN VIEW ========= -->
    <main id="loginView" style="display:none">
      <div class="login-wrap">
        <h3 class="login-title">เข้าสู่ระบบ</h3>
        <p class="login-desc">เข้าสู่ระบบด้วยบัญชี Google เพื่อดูตารางงานของทีม</p>
        <div id="g_id_signin"></div>
      </div>
    </main>

    <!-- ========= APP VIEW ========= -->
    <main id="appView" style="display:none">
      <div class="filters">
        <input type="date" id="dateFilter" class="input" />
        <input type="text" id="searchFilter" class="input" placeholder="ค้นหาชื่อคู่บ่าวสาว / สถานที่..." />
        <select id="memberFilter" class="select">
          <option value="">-- ทีมรันคิว --</option>
        </select>
      </div>

      <div class="card-table">
        <table>
          <thead>
            <tr>
              <th>วันที่</th>
              <th>เวลา</th>
              <th>คู่บ่าวสาว</th>
              <th>สถานที่</th>
              <th>นายพิธี</th>
              <th>ทีมรันคิว</th>
              <th>ลูกค้า</th>
              <th id="thMoney">ค่าทีม</th>
            </tr>
          </thead>
          <tbody id="jobsBody">
            <tr><td colspan="8">โปรดล็อกอิน...</td></tr>
          </tbody>
        </table>
      </div>
    </main>

    <script>
      // ======== STATE ========
      const STATE = {
        user: null,
        jobs: [],
        activeTab: "all"
      };

      // ======== LOGIN (GIS) ========
      // เรียกเมื่อหน้าโหลดเสร็จ
      function initLoginUI() {
        const CLIENT_ID = "898172037733-mmoa0doroi7i484vse3or5aqbj3oks0m.apps.googleusercontent.com"; // ← แก้เป็นของคุณ
        const CORRECT_ORIGIN = "https://n-duylqi4n4qtj3fszgap7eh2d3brdza3jb7gdmqq-0lu-script.googleusercontent.com"; // (ตัวใหม่จาก Error)(นี่คือตัวใหม่ล่าสุด)
        google.accounts.id.initialize({
          client_id: CLIENT_ID,
          callback: handleCredentialResponse,
          auto_select: false,
          ux_mode: "popup",
          allowed_parent_origin: CORRECT_ORIGIN,
          itp_support: true
        });
        google.accounts.id.renderButton(
          document.getElementById("g_id_signin"),
          { type: "standard", theme: "outline", size: "large", text: "signin_with" }
        );
        showLogin(true);
      }

      // ได้ id_token กลับมาจาก Google → ส่งไป Apps Script ตรวจ
      function handleCredentialResponse(resp) {
        const idToken = resp.credential;
        google.script.run
          .withSuccessHandler(user => {
            STATE.user = user; // {email,name,picture,role,nick}
            renderUserBadge();
            showLogin(false);
            loadJobs();        // ไปดึงงาน
          })
          .withFailureHandler(err => {
            alert("ล็อกอินไม่สำเร็จ: " + err.message);
          })
          .verifyIdToken(idToken);
      }

      function showLogin(show) {
        document.getElementById("loginView").style.display = show ? "" : "none";
        document.getElementById("appView").style.display   = show ? "none" : "";
        document.getElementById("userBox").textContent = show ? "ยังไม่ได้ล็อกอิน" : "";
      }

      function renderUserBadge() {
        const box = document.getElementById("userBox");
        if (!STATE.user) { box.textContent = "ยังไม่ได้ล็อกอิน"; return; }
        box.innerHTML = `
          ${STATE.user.name || STATE.user.email}
          <span class="role-pill">${STATE.user.role}</span>
        `;
      }

      // ======== LOAD JOBS ========
      function loadJobs() {
        google.script.run
          .withSuccessHandler(function(jobs) {
            STATE.jobs = jobs.map(j => ({
              ...j,
              teamArray: j.team ? j.team.split(",").map(s => s.trim()).filter(Boolean) : []
            }));
            buildMemberFilter(STATE.jobs);
            renderJobs();
          })
          .withFailureHandler(err => {
            alert("โหลดงานไม่สำเร็จ: " + err.message);
          })
          .getWeddingJobs(STATE.user.email); // ส่งอีเมลไปให้ฝั่ง server กรองสิทธิ์
      }

      function buildMemberFilter(jobs) {
        const select = document.getElementById("memberFilter");
        select.innerHTML = '<option value="">-- ทีมรันคิว --</option>';
        const set = new Set();
        jobs.forEach(j => j.teamArray.forEach(n => set.add(n)));
        Array.from(set).forEach(name => {
          const opt = document.createElement("option");
          opt.value = name; opt.textContent = name;
          select.appendChild(opt);
        });
      }

      function renderJobs() {
        const body = document.getElementById("jobsBody");
        body.innerHTML = "";

        const selectedDate = document.getElementById("dateFilter").value;
        const keyword = document.getElementById("searchFilter").value.toLowerCase();
        const member = document.getElementById("memberFilter").value;
        const isAdmin = STATE.user?.role === "ADMIN";

        let jobs = [...STATE.jobs];

        if (STATE.activeTab === "mine" && !isAdmin) {
          // “งานของฉัน” เฉพาะ STAFF → ดูจากชื่อเล่นที่อยู่ในทีม
          const myName = STATE.user?.nick || STATE.user?.name || "";
          jobs = jobs.filter(j => j.teamArray.includes(myName));
        }

        jobs = jobs.filter(j => {
          let ok = true;
          if (selectedDate) ok = ok && j.date === selectedDate;
          if (keyword) {
            ok = ok && (
              (j.couple && j.couple.toLowerCase().includes(keyword)) ||
              (j.place && j.place.toLowerCase().includes(keyword))
            );
          }
          if (member) ok = ok && j.teamArray.includes(member);
          return ok;
        });

        // คอลัมน์เงิน: admin เท่านั้น
        document.getElementById("thMoney").style.display = isAdmin ? "" : "none";

        if (jobs.length === 0) {
          body.innerHTML = `<tr><td colspan="8">ไม่พบข้อมูล</td></tr>`;
          return;
        }

        jobs.forEach(j => {
          const tr = document.createElement("tr");
          const timeText = (j.timeStart || j.timeEnd) ? `${j.timeStart || ""} - ${j.timeEnd || ""}` : "-";
          const moneyHtml = isAdmin ? `<span class="money-admin">ใส่เงินทีหลัง</span>` : "";

          tr.innerHTML = `
            <td>${toThaiDate(j.date)}</td>
            <td>${timeText}</td>
            <td>${j.couple || "-"}</td>
            <td>${j.place || "-"}</td>
            <td>${j.mc || "-"}</td>
            <td>${j.teamArray.map(n => `<span class="badge">${n}</span>`).join(" ")}</td>
            <td>${j.customer || "-"}</td>
            <td class="money-cell ${isAdmin ? "" : "hidden"}">${moneyHtml}</td>
          `;
          body.appendChild(tr);
        });
      }

      function toThaiDate(iso) {
        if (!iso) return "-";
        const d = new Date(iso);
        return d.toLocaleDateString("th-TH", { day: "numeric", month: "short", year: "numeric" });
      }

      // ======== EVENTS ========
      document.querySelectorAll(".tab").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          STATE.activeTab = btn.dataset.tab;
          renderJobs();
        });
      });
      document.getElementById("dateFilter").addEventListener("change", renderJobs);
      document.getElementById("searchFilter").addEventListener("input", renderJobs);
      document.getElementById("memberFilter").addEventListener("change", renderJobs);

      // ======== BOOT ========
      window.addEventListener("load", () => {
        // ถ้า script GIS โหลดทัน ก็เริ่มได้เลย
        if (window.google && google.accounts) initLoginUI();
        else setTimeout(() => window.google && initLoginUI(), 400);
      });
    </script>
  </body>
</html>
